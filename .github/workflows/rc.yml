name: RC Build and Tag

on:
  workflow_dispatch:
    inputs:
      rc_number:
        description: 'RC number (e.g., 1 for rc1)'
        required: true
        type: string

jobs:
  build-and-tag-rc:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check branch
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          if [[ "$BRANCH_NAME" == "master" || "$BRANCH_NAME" == "develop" ]]; then
            echo "❌ Error: RC builds are not allowed on master or develop branches"
            echo "Current branch: $BRANCH_NAME"
            exit 1
          fi
          echo "✅ Branch check passed: $BRANCH_NAME"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Get current version from pom.xml
        id: get_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          BASE_VERSION=${VERSION%-SNAPSHOT}
          RC_VERSION="${BASE_VERSION}-rc${{ github.event.inputs.rc_number }}"
          echo "rc_version=${RC_VERSION}" >> $GITHUB_OUTPUT
          echo "Building RC version: ${RC_VERSION}"

      - name: Set RC version
        run: |
          mvn versions:set -DnewVersion=${{ steps.get_version.outputs.rc_version }} -DgenerateBackupPoms=false

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run tests
        run: mvn test

      - name: Create and push tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add pom.xml
          git commit -m "Bump version to ${{ steps.get_version.outputs.rc_version }}"
          git tag -a "v${{ steps.get_version.outputs.rc_version }}" -m "Release Candidate ${{ steps.get_version.outputs.rc_version }}"
          git push origin HEAD:${{ github.ref_name }}
          git push origin "v${{ steps.get_version.outputs.rc_version }}"
